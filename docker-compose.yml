services:
  postgres:
    image: postgres:18@sha256:b6b4d0b75c699a2c94dfc5a94fe09f38630f3b67ab0e1653ede1b7ac8e13c197
    container_name: forgejo-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: forgejo
      POSTGRES_USER: forgejo
      POSTGRES_PASSWORD: change_me_strong_password
    volumes:
      - postgres_data:/var/lib/postgresql/18/docker
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U forgejo -d forgejo"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - forgejo_net

  forgejo:
    image: codeberg.org/forgejo/forgejo:14@sha256:fa8ce5aba7c20e106c649e00da1f568e8f39c58f1706bcf4f6921f16aaf5ba48
    container_name: forgejo
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database
      FORGEJO__database__DB_TYPE: postgres
      FORGEJO__database__HOST: postgres:5432
      FORGEJO__database__NAME: forgejo
      FORGEJO__database__USER: forgejo
      FORGEJO__database__PASSWD: change_me_strong_password

      # Server / reverse proxy
      # IMPORTANT: set these to your real domain
      FORGEJO__server__DOMAIN: git.example.com
      FORGEJO__server__ROOT_URL: https://git.example.com/
      FORGEJO__server__PROTOCOL: http

      # Let Forgejo know it's behind a proxy (usually fine without, but helps)
      FORGEJO__server__ENABLE_GZIP: "true"

      # SSH (Caddy does NOT proxy SSH)
      FORGEJO__server__START_SSH_SERVER: "false"
      FORGEJO__server__DISABLE_SSH: "false"
      FORGEJO__server__SSH_DOMAIN: git.example.com
      FORGEJO__server__SSH_PORT: 2222
      FORGEJO__server__SSH_LISTEN_PORT: 22

      FORGEJO__packages__ENABLED: "true"
      FORGEJO__packages__CONTAINER__ENABLED: "true"
    expose:
      - "3000"  # only to other containers
    ports:
      - "2222:22" # SSH for git over ssh
    volumes:
      - forgejo_data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - forgejo_net

  caddy:
    image: caddy:2@sha256:c3d7ee5d2b11f9dc54f947f68a734c84e9c9666c92c88a7f30b9cba5da182adb
    container_name: forgejo-caddy
    restart: unless-stopped
    depends_on:
      - forgejo
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - forgejo_net

  # Runner 1: Docker engine for job containers
  dind-runner1:
    image: docker:dind@sha256:8bcbad4b45f0bff9d3e809d85a7ac589390f0be8acbc526850c998c35c1243fd
    container_name: forgejo-dind-runner1
    privileged: true
    restart: unless-stopped
    command: ["dockerd", "-H", "tcp://0.0.0.0:2375", "--tls=false"]
    networks:
      - forgejo_net

  runner1:
    image: data.forgejo.org/forgejo/runner:12@sha256:8d12845540f005ce12cd25bb3cc229b9eded4c30778a1e9a2e4918ba668489a8
    container_name: forgejo-runner1
    restart: unless-stopped
    depends_on:
      dind-runner1:
        condition: service_started
    environment:
      DOCKER_HOST: tcp://dind-runner1:2375
    user: "1001:1001"
    volumes:
      - ./runners/runner1:/data
    # command: '/bin/sh -c "while : ; do sleep 1 ; done"' # first boot: keep it idle so you can exec in and register it
    command: '/bin/sh -c "sleep 5; if [ -f /data/.runner ]; then forgejo-runner daemon; else echo \"Waiting for registration...\"; while : ; do sleep 1 ; done; fi"'
    networks:
      - forgejo_net

  # Runner 2
  dind-runner2:
    image: docker:dind@sha256:8bcbad4b45f0bff9d3e809d85a7ac589390f0be8acbc526850c998c35c1243fd
    container_name: forgejo-dind-runner2
    privileged: true
    restart: unless-stopped
    command: ["dockerd", "-H", "tcp://0.0.0.0:2375", "--tls=false"]
    networks:
      - forgejo_net

  runner2:
    image: data.forgejo.org/forgejo/runner:12@sha256:8d12845540f005ce12cd25bb3cc229b9eded4c30778a1e9a2e4918ba668489a8
    container_name: forgejo-runner2
    restart: unless-stopped
    depends_on:
      dind-runner2:
        condition: service_started
    environment:
      DOCKER_HOST: tcp://dind-runner2:2375
    user: "1001:1001"
    volumes:
      - ./runners/runner2:/data
    # command: '/bin/sh -c "while : ; do sleep 1 ; done"' # pre registration

    command: '/bin/sh -c "sleep 5; if [ -f /data/.runner ]; then forgejo-runner daemon; else echo \"Waiting for registration...\"; while : ; do sleep 1 ; done; fi"' # post registration
    networks:
      - forgejo_net

  ollama:
    image: ollama/ollama:latest@sha256:a1c8f0c7d086877ce7f508b1146ca482b765ea34c7d2e35c19fb3c75cd3d5a90
    container_name: forgejo-ollama
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama
    # If you have an NVIDIA GPU, you'd add the runtime/devices bits here.
    # CPU/Thread Allocation (uncomment to enable):
    # cpus: 4.0                    # Limit to 4 CPUs (accepts decimals like 2.5)
    # cpuset_cpus: "0-3"           # Pin to specific CPU cores (0-indexed)
    # cpu_shares: 2048             # Relative CPU priority (default: 1024)
    # Environment variables for Ollama performance tuning:
    # environment:
    #   - OLLAMA_NUM_PARALLEL=4    # Number of parallel requests (default: auto)
    #   - OLLAMA_MAX_LOADED_MODELS=1  # Max models in memory (default: 1)
    expose:
      - "11434"
    networks:
      - forgejo_net

  auditlm:
    build:
      context: ./auditlm
    container_name: forgejo-auditlm
    restart: unless-stopped
    depends_on:
      - forgejo
      - ollama
    environment:
      # auditlm expects the Forgejo bot token in FORGEJO_TOKEN
      FORGEJO_TOKEN: "${AUDITLM_TOKEN}"
    volumes:
      # Let auditlm create "analysis containers" on the host Docker
      - /var/run/docker.sock:/var/run/docker.sock
    command: >
      forgejo
      --model "qwen2.5-coder:7b-instruct"
      --socket "/var/run/docker.sock"
      --base-url "http://ollama:11434/v1"
      --forgejo-url "http://forgejo:3000"
      --image "rust:1-trixie"
    networks:
      - forgejo_net

  forgejo-mcp:
    image: ronmi/forgejo-mcp:latest@sha256:9fad02dfad4a61be3e9c40e1e95d2b2c28a44aa3e88f5c6db7a2ccde50f52e53
    container_name: forgejo-mcp
    restart: unless-stopped
    depends_on:
      - forgejo
    environment:
      FORGEJOMCP_TOKEN: "${FORGEJO_MCP_TOKEN}"
      FORGEJOMCP_SERVER: "http://forgejo:3000"
    expose:
      - "8080"
    command: >
      http
      --address :8080
      --server http://forgejo:3000
    networks:
      - forgejo_net

  renovate:
    image: renovate/renovate:39@sha256:99198d61d3c837085bdc94e0eafb1d57de3ecbfdc2e5e994817e589f71eacd16
    container_name: renovate
    restart: unless-stopped
    environment:
      # Renovate auth + platform
      RENOVATE_TOKEN: "${RENOVATE_TOKEN}"           # bot PAT
      RENOVATE_GITHUB_TOKEN: "${RENOVATE_GITHUB_TOKEN}" # access to github
      RENOVATE_PLATFORM: "forgejo"
      RENOVATE_ENDPOINT: "https://git.example.com/api/v1"

      # Logging (handy at first)
      LOG_LEVEL: "info"

      # Where the global config lives inside the container
      RENOVATE_CONFIG_FILE: "/tmp/renovate-config.js"

      RENOVATE_GIT_AUTHOR: "Renovate Bot <renovate-bot@example.com>"
      GIT_AUTHOR_NAME: "Renovate Bot"
      GIT_AUTHOR_EMAIL: "renovate-bot@example.com"
      GIT_COMMITTER_NAME: "Renovate Bot"
      GIT_COMMITTER_EMAIL: "renovate-bot@example.com"
    volumes:
      - ./renovate/config.js:/tmp/renovate-config.js:ro
      - renovate_cache:/tmp/renovate
    # Run on a schedule. Example: daily at 02:15
    command: >
      sh -lc 'while true; do 
        echo "Starting Renovate run at $(date)"; 
        renovate; 
        EXIT_CODE=$?; 
        if [ $EXIT_CODE -ne 0 ]; then 
          echo "Renovate exited with code $EXIT_CODE at $(date)"; 
        fi; 
        echo "Sleeping for 600 seconds..."; 
        sleep 600; 
      done'

networks:
  forgejo_net:

volumes:
  postgres_data:
  forgejo_data:
  caddy_data:
  caddy_config:
  renovate_cache:
  ollama_data:
